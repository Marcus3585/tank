<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Three.js å¦å…‹å¤§æˆ° (PvE æ¨¡å¼)</title>
    <style>
        body { margin: 0; overflow: hidden; background-color: #1a1a1a; font-family: "Microsoft JhengHei", Arial, sans-serif; user-select: none; }
        
        #canvas-container { position: absolute; top: 0; left: 0; width: 100%; height: 100vh; z-index: 1; }
        .input_video { display: none; }
        
        /* 2D HUD ç•«å¸ƒ */
        #output_canvas {
            position: absolute; top: 20px; right: 20px;
            width: 320px; height: 240px;
            z-index: 2;
            border: 2px solid rgba(0, 255, 255, 0.3);
            border-radius: 10px;
            background: rgba(0, 0, 0, 0.6);
            transform: scaleX(-1); 
            transition: transform 0.3s ease;
        }

        /* UI å…ƒç´  */
        #hp-display {
            position: absolute; top: 20px; left: 20px; z-index: 5;
            font-size: 32px; color: #ff3333; text-shadow: 2px 2px 0 #000;
        }

        #game-message {
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
            z-index: 20; color: white; text-align: center;
            display: none; /* é è¨­éš±è— */
            background: rgba(0, 0, 0, 0.85);
            padding: 40px; border-radius: 20px; border: 2px solid #fff;
        }
        #game-message h1 { font-size: 48px; margin: 0 0 20px 0; }
        #restart-btn {
            background: #ff3333; color: white; border: none; padding: 15px 30px;
            font-size: 24px; cursor: pointer; border-radius: 10px; font-family: inherit;
        }
        #restart-btn:hover { background: #ff6666; }

        #loading {
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
            z-index: 10; color: #00ffff; font-size: 24px; font-weight: bold;
            background: rgba(0,0,0,0.8); padding: 30px; border-radius: 15px;
            border: 1px solid #00ffff;
            box-shadow: 0 0 20px rgba(0, 255, 255, 0.2);
            text-align: center;
        }

        #instructions {
            position: absolute; bottom: 20px; left: 20px; z-index: 2;
            color: white; background: rgba(0,0,0,0.5); padding: 15px;
            border-radius: 8px; pointer-events: none;
            border-left: 4px solid #00ff00;
            width: 250px;
        }
        
        #settings-panel {
            position: absolute; top: 280px; right: 20px; z-index: 5;
            display: flex; flex-direction: column; gap: 10px;
        }
        .btn {
            background: rgba(0, 255, 255, 0.2); border: 1px solid #00ffff;
            color: white; padding: 8px 15px; cursor: pointer; font-size: 14px;
            border-radius: 5px; transition: 0.2s; font-family: inherit;
        }
        .btn:hover { background: rgba(0, 255, 255, 0.5); }
        .btn.active { background: #00ffff; color: black; font-weight: bold; }

        /* é¢¨æ ¼é¸æ“‡å™¨æ¨£å¼ */
        select {
            background: rgba(0, 0, 0, 0.8); color: #00ffff; border: 1px solid #00ffff;
            padding: 8px; border-radius: 5px; font-family: inherit; cursor: pointer;
        }

        /* å—å‚·ç´…å±ç‰¹æ•ˆ */
        #damage-overlay {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: red; opacity: 0; pointer-events: none; z-index: 4;
            transition: opacity 0.1s;
        }

        h3 { margin-top: 0; color: #00ff00; font-size: 18px; }
        .highlight { color: #ffff00; font-weight: bold; }
    </style>
</head>
<body>

<div id="damage-overlay"></div>
<div id="loading">ç³»çµ±å•Ÿå‹•ä¸­...<br><span style="font-size:16px; color:#aaa;">Hands + Face Mesh</span></div>

<div id="hp-display">â¤ï¸â¤ï¸â¤ï¸â¤ï¸â¤ï¸</div>

<div id="game-message">
    <h1 id="msg-title">GAME OVER</h1>
    <button id="restart-btn" onclick="resetGame()">é‡æ–°é–‹å§‹</button>
</div>

<div id="instructions">
    <h3>ä½œæˆ°ç°¡å ±</h3>
    <p>ğŸ¯ <span class="highlight">ä»»å‹™</span>ï¼šæ¶ˆæ»… 2 è¼›ç´…è‰²æ•µè»</p>
    <p>â¤ï¸ <span class="highlight">ç”Ÿå­˜</span>ï¼šä½ æœ‰ 5 é»ç”Ÿå‘½å€¼</p>
    <p>ğŸ–ï¸ å·¦æ‰‹ç§»å‹• | å³æ‰‹ç„æº–+å°„æ“Š</p>
    <p>ğŸ˜ é ­éƒ¨æ“ºå‹•æ§åˆ¶è¦–è§’</p>
</div>

<div id="settings-panel">
    <button class="btn active" id="btn-mirror" onclick="toggleMirror()">é¡é ­é¡åƒ: é–‹</button>
    <button class="btn" id="btn-invert" onclick="toggleInvert()">æ“æ§åå‘: é—œ</button>
    
    <!-- é¢¨æ ¼é¸æ“‡å™¨ -->
    <select id="style-select" onchange="changeVisualStyle(this.value)">
        <option value="standard">ğŸ¨ é¢¨æ ¼: æ¨™æº–æˆ°å ´</option>
        <option value="cyber">ğŸŒƒ é¢¨æ ¼: è³½åšé¾å…‹ (Neon)</option>
        <option value="toon">ğŸŒˆ é¢¨æ ¼: å¡é€šæ¸²æŸ“ (Toon)</option>
    </select>
</div>

<video class="input_video"></video>
<canvas id="output_canvas" width="640" height="480"></canvas>
<div id="canvas-container"></div>

<!-- Scripts: ä½¿ç”¨é–å®šç‰ˆæœ¬çš„ MediaPipe ä»¥ç¢ºä¿ç©©å®šæ€§ -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils@0.3.1675466862/camera_utils.js" crossorigin="anonymous"></script>
<script src="https://cdn.jsdelivr.net/npm/@mediapipe/control_utils@0.6.1675466023/control_utils.js" crossorigin="anonymous"></script>
<script src="https://cdn.jsdelivr.net/npm/@mediapipe/drawing_utils@0.3.1675466124/drawing_utils.js" crossorigin="anonymous"></script>
<script src="https://cdn.jsdelivr.net/npm/@mediapipe/hands@0.4.1675469240/hands.js" crossorigin="anonymous"></script>
<script src="https://cdn.jsdelivr.net/npm/@mediapipe/face_mesh@0.4.1673573359/face_mesh.js" crossorigin="anonymous"></script>

<script>
    // --- 0. å…¨å±€è¨­å®š ---
    const SMOOTH_FACTOR = 0.15;
    const HEAD_SMOOTH = 0.1; 
    const SENSITIVITY = 2.5;
    const DEADZONE = 0.1;
    const FIRE_COOLDOWN = 400; // ç©å®¶å°„é€Ÿ
    const ENEMY_FIRE_COOLDOWN = 2000; // æ•µè»å°„é€Ÿ (æ¯«ç§’)
    const PLAYER_MAX_HP = 5;

    let isMirrored = true;
    let isSteeringInverted = false;
    let isGameOver = false;
    let currentStyle = 'standard'; // ç•¶å‰é¢¨æ ¼

    // éŠæˆ²æ•¸æ“š
    let playerHP = PLAYER_MAX_HP;
    const targetInput = { move: { x: 0, y: 0 }, aim: { x: 0, y: 0 }, head: { x: 0, y: 0 } };
    const input = { move: { x: 0, y: 0 }, aim: { x: 0, y: 0 }, head: { x: 0, y: 0 } };
    let lastFireTime = 0;

    const JOYSTICK_LEFT = { x: 0.75, y: 0.6 }; 
    const JOYSTICK_RIGHT = { x: 0.25, y: 0.6 };

    // --- é¢¨æ ¼å®šç¾© ---
    const STYLES = {
        standard: {
            background: 0x1a1a1a,
            fog: 0x1a1a1a,
            ground: 0x333333,
            player: 0x4B5320, // è»ç¶ 
            enemy: 0xAA3333,  // ç´…
            obstacle: 0x555555,
            wireframe: false,
            matType: 'MeshStandardMaterial'
        },
        cyber: {
            background: 0x000000,
            fog: 0x000000,
            ground: 0x000000,
            player: 0x00ff00, // è¢å…‰ç¶ 
            enemy: 0xff0000,  // è¢å…‰ç´…
            obstacle: 0x0000ff, // è¢å…‰è—
            wireframe: true,
            matType: 'MeshBasicMaterial'
        },
        toon: {
            background: 0x87CEEB, // å¤©ç©ºè—
            fog: 0x87CEEB,
            ground: 0x7CFC00,     // è‰åœ°ç¶ 
            player: 0x228B22,     // æ·±ç¶ 
            enemy: 0xFF4500,      // æ©˜ç´…
            obstacle: 0x808080,   // ç°
            wireframe: false,
            matType: 'MeshToonMaterial'
        }
    };

    // --- UI èˆ‡åˆ‡æ›åŠŸèƒ½ ---
    function updateHPDisplay() {
        let hearts = "";
        for(let i=0; i<playerHP; i++) hearts += "â¤ï¸";
        document.getElementById('hp-display').innerText = hearts;
    }

    function showDamageEffect() {
        const overlay = document.getElementById('damage-overlay');
        overlay.style.opacity = 0.6;
        setTimeout(() => { overlay
